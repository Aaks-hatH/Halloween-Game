<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Locked Dungeon</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: #fff;
    padding: 20px;
    min-height: 100vh;
  }
  .container { max-width: 1400px; margin: 0 auto; }
  h1 {
    text-align: center;
    margin-bottom: 10px;
    font-size: 2.5rem;
    text-shadow: 0 0 20px #ff8c00;
  }
  .subtitle {
    text-align: center;
    color: #ff8c00;
    margin-bottom: 30px;
  }

  .login-box {
    max-width: 400px;
    margin: 100px auto;
    background: rgba(30, 30, 60, 0.8);
    padding: 40px;
    border-radius: 15px;
    border: 2px solid #ff8c00;
  }
  .login-box h2 {
    margin-bottom: 20px;
    color: #ff8c00;
  }
  input[type="password"] {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    background: rgba(20, 20, 40, 0.8);
    border: 1px solid #ff8c00;
    border-radius: 8px;
    color: #fff;
    font-size: 1rem;
  }
  button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #ff8c00, #ff6600);
    border: none;
    border-radius: 8px;
    color: #000;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
  }
  button:hover { opacity: 0.9; }

  .dashboard { display: none; }
  .dashboard.active { display: block; }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .stat-card {
    background: rgba(30, 30, 60, 0.8);
    padding: 25px;
    border-radius: 12px;
    border: 1px solid #ff8c00;
    text-align: center;
  }
  .stat-value {
    font-size: 3rem;
    color: #ff8c00;
    font-weight: bold;
    margin: 10px 0;
  }
  .stat-label {
    color: #aaa;
    font-size: 0.9rem;
    text-transform: uppercase;
  }

  .section {
    background: rgba(30, 30, 60, 0.8);
    padding: 25px;
    border-radius: 12px;
    border: 1px solid #ff8c00;
    margin-bottom: 20px;
  }
  .section h2 {
    color: #ff8c00;
    margin-bottom: 20px;
    font-size: 1.5rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 140, 0, 0.2);
  }
  th {
    background: rgba(255, 140, 0, 0.1);
    color: #ff8c00;
    font-weight: 600;
  }
  tr:hover {
    background: rgba(255, 140, 0, 0.05);
  }

  .badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
  }
  .badge-easy { background: #00aa00; color: #fff; }
  .badge-medium { background: #ffaa00; color: #000; }
  .badge-hard { background: #ff0000; color: #fff; }
  .badge-attempt { background: #3498db; color: #fff; }
  .badge-complete { background: #2ecc71; color: #fff; }
  .badge-locked { background: #e74c3c; color: #fff; }
  .badge-hint { background: #9b59b6; color: #fff; }

  .controls {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }
  .controls button {
    flex: 1;
    min-width: 150px;
  }
  .btn-danger {
    background: linear-gradient(135deg, #ff0000, #cc0000) !important;
    color: #fff !important;
  }
  .btn-secondary {
    background: linear-gradient(135deg, #666, #444) !important;
    color: #fff !important;
  }

  .error {
    color: #ff4444;
    margin-top: 10px;
    text-align: center;
  }

  .empty-state {
    text-align: center;
    color: #888;
    padding: 40px;
    font-style: italic;
  }

  .player-controls {
    display: flex;
    gap: 5px;
  }
  .player-controls button {
    padding: 6px 12px;
    font-size: 0.85rem;
    min-width: auto;
    width: auto;
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    .controls {
      flex-direction: column;
    }
    .controls button {
      width: 100%;
    }
  }
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-box">
  <h2>üîí Admin Login</h2>
  <p style="color: #aaa; margin-bottom: 20px; font-size: 0.9rem;">Enter admin password to access dashboard</p>
  <input type="password" id="adminPassword" placeholder="Enter admin password" autofocus>
  <button onclick="login()">Login</button>
  <p class="error" id="loginError"></p>
</div>

<!-- Dashboard -->
<div id="dashboard" class="dashboard">
  <div class="container">
    <h1>üíÄ Locked Dungeon Admin Dashboard üíÄ</h1>
    <p class="subtitle">Real-time Analytics & Monitoring</p>

    <div class="controls">
      <button onclick="refreshData()">üîÑ Refresh Data</button>
      <button onclick="refreshPlayers()">üë• Refresh Players</button>
      <button onclick="exportData()" class="btn-secondary">üì• Export Data</button>
      <button onclick="clearData()" class="btn-danger">üóëÔ∏è Clear All Data</button>
      <button onclick="logout()" class="btn-secondary">üö™ Logout</button>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-label">Active Players</div>
        <div class="stat-value" id="statActivePlayers">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Attempts</div>
        <div class="stat-value" id="statAttempts">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Completions</div>
        <div class="stat-value" id="statCompletions">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Locked Users</div>
        <div class="stat-value" id="statLocked">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Hints Used</div>
        <div class="stat-value" id="statHints">0</div>
      </div>
    </div>

    <!-- Active Players -->
    <div class="section">
      <h2>üë• Active Players</h2>
      <table>
        <thead>
          <tr>
            <th>Player Name</th>
            <th>Session ID</th>
            <th>Difficulty</th>
            <th>Status</th>
            <th>Last Activity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="playersTable">
          <tr><td colspan="6" class="empty-state">No active players</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Best Times -->
    <div class="section">
      <h2>üèÜ Best Times by Difficulty</h2>
      <table>
        <thead>
          <tr>
            <th>Difficulty</th>
            <th>Best Time</th>
            <th>Average Time</th>
          </tr>
        </thead>
        <tbody id="timesTable">
          <tr><td colspan="3" class="empty-state">No data yet</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Recent Activity -->
    <div class="section">
      <h2>üìä Recent Activity (Last 50 Events)</h2>
      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Session ID</th>
            <th>Difficulty</th>
            <th>Details</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody id="activityTable">
          <tr><td colspan="5" class="empty-state">No activity yet</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Completion Details -->
    <div class="section">
      <h2>‚úÖ Completion Details</h2>
      <table>
        <thead>
          <tr>
            <th>Session ID</th>
            <th>Difficulty</th>
            <th>Time</th>
            <th>Hints Used</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="completionsTable">
          <tr><td colspan="5" class="empty-state">No completions yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const SERVER_URL = window.location.origin;
let adminPassword = '';

function login() {
  const password = document.getElementById('adminPassword').value;
  adminPassword = password;

  fetch(`${SERVER_URL}/api/admin/analytics`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password })
  })
  .then(res => {
    if (!res.ok) throw new Error('Invalid password');
    return res.json();
  })
  .then(data => {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('dashboard').classList.add('active');
    displayData(data);
    refreshPlayers();
  })
  .catch(err => {
    document.getElementById('loginError').textContent = 'Invalid password!';
  });
}

// Allow Enter key to login
document.getElementById('adminPassword').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') login();
});

function refreshData() {
  fetch(`${SERVER_URL}/api/admin/analytics`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: adminPassword })
  })
  .then(res => res.json())
  .then(displayData)
  .catch(err => alert('Error refreshing data: ' + err.message));
}

function refreshPlayers() {
  fetch(`${SERVER_URL}/api/players`)
  .then(res => res.json())
  .then(displayPlayers)
  .catch(err => console.error('Error fetching players:', err));
}

function displayPlayers(players) {
  const playersTable = document.getElementById('playersTable');
  document.getElementById('statActivePlayers').textContent = players.length;
  
  if (players.length === 0) {
    playersTable.innerHTML = '<tr><td colspan="6" class="empty-state">No active players</td></tr>';
    return;
  }

  playersTable.innerHTML = players.map(p => {
    const lastActivity = new Date(p.lastActivity);
    const timeSince = Math.floor((Date.now() - lastActivity) / 1000);
    const activityStr = timeSince < 60 ? `${timeSince}s ago` : 
                       timeSince < 3600 ? `${Math.floor(timeSince/60)}m ago` :
                       `${Math.floor(timeSince/3600)}h ago`;
    
    const displayName = p.playerName || 'Anonymous';
    const sessionIdShort = p.sessionId.slice(0, 8);
    
    return `
      <tr>
        <td><strong>${displayName}</strong></td>
        <td>${sessionIdShort}...</td>
        <td>${p.difficulty ? `<span class="badge badge-${p.difficulty}">${p.difficulty}</span>` : 'N/A'}</td>
        <td>${p.locked ? '<span class="badge badge-locked">üîí Locked</span>' : '<span class="badge badge-complete">üîì Active</span>'}</td>
        <td>${activityStr}</td>
        <td class="player-controls">
          <button onclick="lockPlayer('${p.sessionId}', ${!p.locked})" class="${p.locked ? 'btn-secondary' : 'btn-danger'}">
            ${p.locked ? 'üîì Unlock' : 'üîí Lock'}
          </button>
          <button onclick="resetPlayer('${p.sessionId}')" class="btn-secondary">üîÑ Reset</button>
        </td>
      </tr>
    `;
  }).join('');
}

function lockPlayer(sessionId, locked) {
  fetch(`${SERVER_URL}/api/lock`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sessionId, locked })
  })
  .then(() => {
    refreshPlayers();
    alert(`Player ${locked ? 'locked' : 'unlocked'} successfully!`);
  })
  .catch(err => alert('Error: ' + err.message));
}

function resetPlayer(sessionId) {
  if (!confirm('Reset this player\'s progress?')) return;
  
  fetch(`${SERVER_URL}/api/reset`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sessionId })
  })
  .then(() => {
    refreshPlayers();
    alert('Player reset successfully!');
  })
  .catch(err => alert('Error: ' + err.message));
}

function displayData(data) {
  // Update stats
  document.getElementById('statAttempts').textContent = data.totalAttempts;
  document.getElementById('statCompletions').textContent = data.totalCompletions;
  document.getElementById('statLocked').textContent = data.totalLocked;
  document.getElementById('statHints').textContent = data.totalHints;

  // Update times table
  const timesTable = document.getElementById('timesTable');
  timesTable.innerHTML = `
    <tr>
      <td><span class="badge badge-easy">Easy</span></td>
      <td>${formatTime(data.bestTimeEasy)}</td>
      <td>${formatTime(data.avgTimeEasy)}</td>
    </tr>
    <tr>
      <td><span class="badge badge-medium">Medium</span></td>
      <td>${formatTime(data.bestTimeMedium)}</td>
      <td>${formatTime(data.avgTimeMedium)}</td>
    </tr>
    <tr>
      <td><span class="badge badge-hard">Hard</span></td>
      <td>${formatTime(data.bestTimeHard)}</td>
      <td>${formatTime(data.avgTimeHard)}</td>
    </tr>
  `;

  // Update activity table
  const activityTable = document.getElementById('activityTable');
  if (data.recentActivity.length === 0) {
    activityTable.innerHTML = '<tr><td colspan="5" class="empty-state">No activity yet</td></tr>';
  } else {
    activityTable.innerHTML = data.recentActivity.map(a => `
      <tr>
        <td><span class="badge badge-${a.type}">${a.type}</span></td>
        <td>${a.sessionId ? a.sessionId.slice(0, 8) + '...' : 'N/A'}</td>
        <td>${a.difficulty ? `<span class="badge badge-${a.difficulty}">${a.difficulty}</span>` : 'N/A'}</td>
        <td>${getActivityDetails(a)}</td>
        <td>${new Date(a.timestamp).toLocaleString()}</td>
      </tr>
    `).join('');
  }

  // Update completions table
  const completionsTable = document.getElementById('completionsTable');
  if (data.completionTimes.length === 0) {
    completionsTable.innerHTML = '<tr><td colspan="5" class="empty-state">No completions yet</td></tr>';
  } else {
    completionsTable.innerHTML = data.completionTimes.map(c => `
      <tr>
        <td>${c.sessionId ? c.sessionId.slice(0, 8) + '...' : 'N/A'}</td>
        <td><span class="badge badge-${c.difficulty}">${c.difficulty}</span></td>
        <td>${formatTime(c.time)}</td>
        <td>${c.hintsUsed || 0}</td>
        <td>${new Date(c.timestamp).toLocaleString()}</td>
      </tr>
    `).join('');
  }
}

function getActivityDetails(activity) {
  switch(activity.type) {
    case 'complete':
      return `Time: ${formatTime(activity.time)}, Hints: ${activity.hintsUsed || 0}`;
    case 'locked':
      return `Tab switches: ${activity.tabSwitches}`;
    case 'hint':
      return `Riddle ${activity.riddle}`;
    default:
      return 'Started game';
  }
}

function formatTime(seconds) {
  if (!seconds) return '--';
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function exportData() {
  fetch(`${SERVER_URL}/api/admin/sessions`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: adminPassword })
  })
  .then(res => res.json())
  .then(data => {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dungeon-data-${Date.now()}.json`;
    a.click();
  })
  .catch(err => alert('Error exporting data: ' + err.message));
}

function clearData() {
  if (!confirm('Are you sure you want to delete ALL data? This cannot be undone!')) return;

  fetch(`${SERVER_URL}/api/admin/clear`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: adminPassword })
  })
  .then(res => res.json())
  .then(() => {
    alert('All data cleared!');
    refreshData();
  })
  .catch(err => alert('Error clearing data: ' + err.message));
}

function logout() {
  adminPassword = '';
  document.getElementById('dashboard').classList.remove('active');
  document.getElementById('loginScreen').style.display = 'block';
  document.getElementById('adminPassword').value = '';
  document.getElementById('loginError').textContent = '';
}

// Auto-refresh every 30 seconds
setInterval(() => {
  if (document.getElementById('dashboard').classList.contains('active')) {
    refreshData();
    refreshPlayers();
  }
}, 30000);
</script>
</body>
</html>
